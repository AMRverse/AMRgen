% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/concordance.R
\name{concordance}
\alias{concordance}
\title{Calculate Genotype-Phenotype Concordance}
\usage{
concordance(
  binary_matrix,
  markers = NULL,
  exclude_markers = NULL,
  ppv_threshold = NULL,
  solo_ppv_results = NULL,
  truth = "R",
  prediction_rule = "any"
)
}
\arguments{
\item{binary_matrix}{A data frame output by \code{\link[=get_binary_matrix]{get_binary_matrix()}}, containing
sample-level binary marker presence/absence alongside phenotype columns
(\code{R}, \code{NWT}).}

\item{markers}{A character vector of marker column names to include in the
genotypic prediction. Default \code{NULL} includes all marker columns.}

\item{exclude_markers}{A character vector of marker column names to exclude
from the genotypic prediction. Applied after \code{markers} filtering.}

\item{ppv_threshold}{A numeric PPV threshold (0-1). Markers with solo PPV
below this value are excluded. Requires \code{solo_ppv_results}.}

\item{solo_ppv_results}{Output of \code{\link[=solo_ppv_analysis]{solo_ppv_analysis()}}, used for PPV-based
marker filtering when \code{ppv_threshold} is set.}

\item{truth}{A character string specifying the phenotypic truth column to use:
\code{"R"} (resistant vs susceptible/intermediate, default) or \code{"NWT"}
(non-wildtype vs wildtype).}

\item{prediction_rule}{A character string specifying the rule for generating
genotypic predictions. Currently only \code{"any"} is supported: a sample is
predicted positive if any included marker is present (value of 1).}
}
\value{
An S3 object of class \code{"amr_concordance"}, a list containing:
\itemize{
\item \code{conf_mat}: A yardstick confusion matrix object.
\item \code{metrics}: A tibble with columns \code{.metric}, \code{.estimator}, \code{.estimate}
containing sensitivity, specificity, ppv, npv, accuracy, kap, f_meas, VME,
and ME.
\item \code{data}: The input binary matrix with an added \code{geno_prediction} column.
\item \code{markers_used}: Character vector of markers included in the prediction.
\item \code{truth_col}: Which truth column was used (\code{"R"} or \code{"NWT"}).
\item \code{n}: Total number of samples with non-missing truth values.
}
}
\description{
Compares genotypic predictions (presence of resistance markers) to phenotypic
truth (resistant vs susceptible) using a binary matrix from \code{\link[=get_binary_matrix]{get_binary_matrix()}}.
Calculates standard classification metrics via yardstick and AMR-specific error
rates (VME and ME) per ISO 20776-2.
}
\details{
The function identifies marker columns as all columns not in the reserved set
(\code{id}, \code{pheno}, \code{ecoff}, \code{R}, \code{I}, \code{NWT}, \code{mic}, \code{disk}). It then applies
filtering in order: custom \code{markers} list, \code{exclude_markers}, then
\code{ppv_threshold} filtering.

Genotypic prediction is generated per sample: if \code{prediction_rule = "any"},
then a sample is predicted positive (1) if any selected marker equals 1.

Standard metrics (sensitivity, specificity, PPV, NPV, accuracy, kappa,
F-measure) are calculated using yardstick. AMR-specific error rates are
computed internally:
\itemize{
\item \strong{VME} (Very Major Error): FN / (TP + FN) = 1 - sensitivity. Proportion of
truly resistant isolates missed by genotype.
\item \strong{ME} (Major Error): FP / (TN + FP) = 1 - specificity. Proportion of
truly susceptible isolates incorrectly called resistant by genotype.
}
}
\examples{
\dontrun{
geno_table <- import_amrfp(ecoli_geno_raw, "Name")

binary_matrix <- get_binary_matrix(
  geno_table = geno_table,
  pheno_table = ecoli_ast,
  antibiotic = "Ciprofloxacin",
  drug_class_list = c("Quinolones"),
  sir_col = "pheno_clsi"
)

# Basic concordance using all markers
result <- concordance(binary_matrix)
result

# Exclude specific markers
result <- concordance(binary_matrix, exclude_markers = c("qnrS1"))

# Filter markers by solo PPV threshold
solo_ppv <- solo_ppv_analysis(binary_matrix = binary_matrix)
result <- concordance(
  binary_matrix,
  ppv_threshold = 0.5,
  solo_ppv_results = solo_ppv
)

# Access components
result$conf_mat
result$metrics
result$markers_used
}
}
\seealso{
\code{\link[=get_binary_matrix]{get_binary_matrix()}}, \code{\link[=solo_ppv_analysis]{solo_ppv_analysis()}}
}
