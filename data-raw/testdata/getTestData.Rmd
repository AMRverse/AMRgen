---
title: "Get test data"
output: html_document
date: "2025-01-23"
---

# E. coli

``` {r}
amrfp_ecoli <- "/Users/ipmbkhot/Library/CloudStorage/GoogleDrive-drkatholt@gmail.com/My\ Drive/AMRnet/resistance\ rules/AMRFP_results.tsv.gz"
ncbi_ecoli <- "/Users/ipmbkhot/Documents/GitHub/ecoli/AST/Ecoli_AST_NCBI.tsv.gz"
```


## find biosamples with CLSI MIC data for ciprofloxacin, imipenem and meropenem
```{r }
ast <- read_tsv(ncbi_ecoli)

ast_cip_imi_mero <- ast %>% filter(Antibiotic %in% c("ciprofloxacin", "imipenem", "meropenem")) %>% filter(`Testing standard`=="CLSI") %>% filter(!is.na(`MIC (mg/L)`))

ast_cip_imi_mero_biosamples <- ast_cip_imi_mero %>% select(`#BioSample`, Antibiotic, `MIC (mg/L)`) %>% pivot_wider(id_cols=`#BioSample`, names_from=Antibiotic, values_from=`MIC (mg/L)`) %>% filter(!is.na(ciprofloxacin) & !is.na(imipenem) & !is.na(meropenem)) %>% pull(`#BioSample`)

ast_mini <- ast %>% filter(`#BioSample` %in% ast_cip_imi_mero_biosamples) %>% filter(Antibiotic %in% c("ciprofloxacin", "meropenem", "imipenem")) %>% filter(`Testing standard`=="CLSI") %>% filter(`Scientific name`=="Escherichia coli")

length(unique(ast_mini$`#BioSample`))
length(unique(atb_mini$Name))

```

## read in AMRfinderplus data for these biosamples
```{r }
f <- function(x, pos) subset(x, Name %in% ast_cip_imi_mero_biosamples)
  
# read lines for selected taxa  
atb_mini <- read_tsv_chunked(file=amrfp_ecoli, callback=DataFrameCallback$new(f), chunk_size = 10000)
  
atb_mini <- atb %>% filter(Name %in% ast_cip_imi_mero_biosamples)

```

# write out all, useful for testing e.g. MIC violin plot code
```{r}
write_tsv(atb_mini, file="Ecoli_AMRfinderplus.tsv")
write_tsv(ast_mini, file="Ecoli_AST_NCBI.tsv")
```

# write out first 50 samples, useful for testing e.g. parsers
```{r}
biosample50 <- ast_cip_imi_mero_biosamples[1:50]
write_tsv(atb_mini %>% filter(Name %in% biosample50), file="Ecoli_AMRfinderplus_n50.tsv")
write_tsv(ast_mini %>% filter(`#BioSample` %in% biosample50), file="Ecoli_AST_NCBI_n50.tsv")
```

# import using import_ncbi_ast and write out all, useful for testing PPV etc
``` {r}
ecoli_interpret <- import_ncbi_ast("testdata/Ecoli_AST_NCBI.tsv", interpret=T, ecoff=T)
write_tsv(ecoli_interpret, "testdata/Ecoli_AST_NCBI_reinterpreted.tsv")

# check for differences in interpretation vs input file
ecoli_interpret %>% group_by(pheno, `Resistance phenotype`, `Testing standard`) %>% count()
```